@model List<Library_Management_System.Models.Book>
@{
    Layout = "_StudentLayout";
    ViewData["Title"] = "Library";
}
<div class="container mx-auto px-4 py-6">
    <div class="mb-8">
        <input 
            type="text" 
            id="searchInput"
            placeholder="Search for books..."
            class="w-full md:w-1/2 p-3 rounded shadow border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
        />
    </div>

    <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">New Arrivals</h2>
        <div id="newBooksContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- New books rendered via JS -->
        </div>
    </div>


    <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">All Books</h2>
        <div id="loadBookError" class="hidden bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded-md mt-2" role="alert">
            <p class="font-medium" id="loadBookErrorText"></p>
        </div>
        <div id="booksContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          
        </div>
    </div>
</div>

@section Scripts{
<script>
    const booksContainer = document.getElementById('booksContainer');
    const newBooksContainer = document.getElementById('newBooksContainer');
    const searchInput = document.getElementById('searchInput');
    const errorDiv = document.getElementById('loadBookError');
    const errorText = document.getElementById('loadBookErrorText');
    const loadingDiv = document.createElement('div');

    loadingDiv.textContent = 'Loading more books...';
    loadingDiv.className = 'text-gray-500 text-center mt-4';
    booksContainer.parentNode.appendChild(loadingDiv);
    loadingDiv.style.display = 'none';
    let currentPage = 1;
    let totalPages = 1;
    let currentTerm = '';
    let isLoading = false;

    // Normalize book object
    function normalizeBook(book) {
        return {
            Book_id: book.BookId ||book.bookId,
            Book_Name: book.BookName||book.bookName,
            Author: book.Author||book.author,
            Publisher: book.Publisher||book.publisher,
            Price: book.Price||book.price,
            Image_Url: book.ImageUrl||book.imageUrl,
        };
    }


    function createBookCard(book) {
        
        return Object.assign(document.createElement('div'), {
            className: 'bg-white rounded-lg shadow hover:shadow-xl transition overflow-hidden flex flex-col',
            innerHTML: `
            <img src="${book.Image_Url}" alt="${book.Book_Name}" class="w-full h-48 object-cover">
            <div class="p-4 flex-1 flex flex-col justify-between">
                <div>
                    <h3 class="font-semibold text-lg text-gray-800">${book.Book_Name}</h3>
                    <p class="text-gray-500 mt-1">by ${book.Author}</p>
                </div>
                <div class="mt-3 flex justify-between items-center">
                    <span class="text-indigo-600 font-bold">Rs.${book.Price.toFixed(2)}</span>
                    <div class="space-x-2">
                        <button onclick="rentBook(${book.Book_id})" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition text-sm">Rent</button>
                        <button onclick="buyBook(${book.Book_id})" class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 transition text-sm">Buy</button>
                    </div>
                </div>
            </div>
        `
        });
    }

    // Render books
    function renderBooks(container, booksArray, append = true) {
        if (!append) container.innerHTML = '';
        booksArray.forEach(book => container.appendChild(createBookCard(normalizeBook(book))));
    }
    
    async function fetchBooks(term = '', page = 1) {
        if (isLoading) return;
        if (page > totalPages) return;

        isLoading = true;
        loadingDiv.style.display = 'block';
        errorDiv.classList.add('hidden');

        try {
            const url = term
                ? '/api/student/search?searchTerm=' + encodeURIComponent(term) + '&page=' + page
                : '/api/student/paginated?page=' + page + '&size=6';
            
            const response = await secureFetch(url, {
                    method: 'GET',
                    headers: {
                        "Content-Type": "application/json",
                    },
                }
            );
            if (!response.ok) {
                return;
            }

            const data = await response.json();
            const items =data.items;

            totalPages = data.totalPages;
            renderBooks(booksContainer, items, page > 1);

            if (items.length === 0 && page === 1) {
                errorText.textContent = "We couldn't find any books matching your search. Please try different keywords.";
                errorDiv.classList.remove('hidden');
            }
        } catch (err) {
            errorText.textContent = "Oops! Something went wrong. Please try again later.";
            errorDiv.classList.remove('hidden');
        } finally {
            loadingDiv.style.display = 'none';
            isLoading = false;
        }
}

    // Load initial books
    let newestBooks = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));;
    renderBooks(newBooksContainer, newestBooks);
    fetchBooks();

    // Debounce function
    function debounce(fn, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    // Handle search input
    searchInput.addEventListener('input', debounce((e) => {
        currentTerm = e.target.value.trim();
        currentPage = 1;
        totalPages = 1;
        booksContainer.innerHTML = '';

        fetchBooks(currentTerm, currentPage);
    }, 500));

    // Infinite scroll / lazy load
    window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
            if (!isLoading && currentPage <= totalPages) {
                fetchBooks(currentTerm, currentPage + 1);
                currentPage++;
            }
        }
});
    
    function buyBook(id) {
       $.ajax({
           method: 'POST',
           url: `/api/student/buy-book`,
           data: {
               id: id,
           },
           success:function (response) {
               if (response.status === "success") {
                   Swal.fire({
                       icon: 'success',
                       title: 'Success!',
                       message:"buy request sent successfully!"
                   });
               }else{
                   Swal.fire({
                       icon: 'error',
                       title: 'Error!',
                       message:response.message,
                   });
               }
       },
           error:function (error) {
               console.log(error);
           }
       });
       
        
    }

</script>
}

  